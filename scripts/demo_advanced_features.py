#!/usr/bin/env python3
"""
D√©monstration des fonctionnalit√©s avanc√©es de rapports LCPI-CLI
- Cache intelligent
- Parall√©lisation
- Synth√®se intelligente
- Rapports diff√©rentiels
"""

import sys
import pathlib
import json
import time
from src.lcpi.report_enhanced import ReportCache, ReportAnalyzer, ParallelAnalyzer
from src.lcpi.reporter import ReportGenerator

def demo_cache_system():
    """D√©monstration du syst√®me de cache."""
    print("üîß D√©monstration du syst√®me de cache")
    print("=" * 50)
    
    # Cr√©er un cache
    cache = ReportCache("demo_cache")
    
    # Simuler des donn√©es de test
    test_data = {
        "element_id": "Test_Element",
        "plugin": "demo",
        "statut": "OK",
        "resultats": {"test": "value"}
    }
    
    # Cr√©er un fichier de test
    test_file = pathlib.Path("test_file.yml")
    test_file.write_text("test content")
    
    # Mettre en cache un r√©sultat
    cache.cache_result(test_file, test_data)
    print("‚úÖ Donn√©es mises en cache")
    
    # R√©cup√©rer depuis le cache
    cached_result = cache.get_cached_result(test_file)
    if cached_result:
        print("‚úÖ Donn√©es r√©cup√©r√©es depuis le cache")
        print(f"   √âl√©ment: {cached_result['element_id']}")
    else:
        print("‚ùå Donn√©es non trouv√©es en cache")
    
    # Vider le cache
    cache.clear_cache()
    print("‚úÖ Cache vid√©")
    
    # Nettoyer
    test_file.unlink()
    print()

def demo_synthesis():
    """D√©monstration de la synth√®se intelligente."""
    print("üß† D√©monstration de la synth√®se intelligente")
    print("=" * 50)
    
    # Donn√©es de test
    test_results = [
        {
            "element_id": "Poutre_P1",
            "plugin": "beton",
            "statut": "OK",
            "resultats": {
                "ratio_flexion": "0.85",
                "coefficient_securite": "1.25",
                "verification": "Satisfaisant"
            }
        },
        {
            "element_id": "Panne_T1",
            "plugin": "bois",
            "statut": "Avertissement",
            "resultats": {
                "ratio_flexion": "0.95",
                "coefficient_securite": "1.05",
                "verification": "Limite"
            }
        },
        {
            "element_id": "Reservoir_R1",
            "plugin": "hydrodrain",
            "statut": "Erreur",
            "resultats": {
                "ratio_pression": "1.15",
                "verification": "Non conforme"
            }
        }
    ]
    
    # G√©n√©rer la synth√®se
    synthesis = ReportAnalyzer.generate_synthesis(test_results)
    
    print(f"üìä Total √©l√©ments: {synthesis['total_elements']}")
    print(f"üéØ Taux de succ√®s: {synthesis['success_rate']:.1f}%")
    print(f"üîß Plugins utilis√©s: {', '.join(synthesis['plugins_used'])}")
    print(f"‚ö†Ô∏è  Avertissements: {len(synthesis['warnings'])}")
    print(f"‚ùå Erreurs: {len(synthesis['errors'])}")
    print(f"üìà Ratios critiques: {len(synthesis['critical_ratios'])}")
    
    print("\nüìã Ratios critiques (Top 3):")
    for i, ratio in enumerate(synthesis['critical_ratios'][:3], 1):
        print(f"   {i}. {ratio['element']} - {ratio['parameter']}: {ratio['value']:.2f} ({ratio['status']})")
    
    print()

def demo_comparison():
    """D√©monstration de la comparaison de rapports."""
    print("üîÑ D√©monstration de la comparaison de rapports")
    print("=" * 50)
    
    # Rapport pr√©c√©dent
    previous_results = [
        {
            "element_id": "Poutre_P1",
            "plugin": "beton",
            "statut": "OK",
            "resultats": {
                "ratio_flexion": "0.80",
                "coefficient_securite": "1.20"
            }
        },
        {
            "element_id": "Panne_T1",
            "plugin": "bois",
            "statut": "OK",
            "resultats": {
                "ratio_flexion": "0.90",
                "coefficient_securite": "1.10"
            }
        }
    ]
    
    # Rapport actuel
    current_results = [
        {
            "element_id": "Poutre_P1",
            "plugin": "beton",
            "statut": "OK",
            "resultats": {
                "ratio_flexion": "0.85",
                "coefficient_securite": "1.25"
            }
        },
        {
            "element_id": "Panne_T1",
            "plugin": "bois",
            "statut": "Avertissement",
            "resultats": {
                "ratio_flexion": "0.95",
                "coefficient_securite": "1.05"
            }
        },
        {
            "element_id": "Reservoir_R1",
            "plugin": "hydrodrain",
            "statut": "Erreur",
            "resultats": {
                "ratio_pression": "1.15"
            }
        }
    ]
    
    # Comparer les rapports
    comparison = ReportAnalyzer.compare_reports(current_results, previous_results)
    
    print(f"üìä R√©sum√© des changements:")
    print(f"   ‚Ä¢ √âl√©ments ajout√©s: {comparison['summary_changes']['elements_added']}")
    print(f"   ‚Ä¢ √âl√©ments supprim√©s: {comparison['summary_changes']['elements_removed']}")
    print(f"   ‚Ä¢ √âl√©ments modifi√©s: {comparison['summary_changes']['elements_modified']}")
    
    print(f"\nüìù √âl√©ments ajout√©s: {', '.join(comparison['added_elements'])}")
    print(f"üóëÔ∏è  √âl√©ments supprim√©s: {', '.join(comparison['removed_elements'])}")
    
    print(f"\nüîß Modifications d√©taill√©es:")
    for mod in comparison['modified_elements']:
        print(f"   ‚Ä¢ {mod['element_id']}:")
        for change in mod['changes']:
            if change['type'] == 'numeric' and 'change_percent' in change:
                print(f"     - {change['field']}: {change['old']} ‚Üí {change['new']} ({change['change_percent']:+.1f}%)")
            else:
                print(f"     - {change['field']}: {change['old']} ‚Üí {change['new']}")
    
    print()

def demo_parallel_analysis():
    """D√©monstration de l'analyse parall√®le."""
    print("‚ö° D√©monstration de l'analyse parall√®le")
    print("=" * 50)
    
    # Cr√©er un cache pour la d√©mo
    cache = ReportCache("parallel_demo_cache")
    
    # Cr√©er l'analyseur parall√®le
    analyzer = ParallelAnalyzer(cache=cache, max_workers=2)
    
    # Configuration des plugins
    plugin_commands = {
        "cm": "calc",
        "bois": "check",
        "beton": "calc",
        "hydrodrain": "calc"
    }
    
    project_dir = pathlib.Path.cwd()
    
    print(f"üìÅ Projet: {project_dir.name}")
    print(f"üîß Workers: {analyzer.max_workers}")
    print(f"üíæ Cache: {'Activ√©' if cache else 'D√©sactiv√©'}")
    
    # Mesurer le temps
    start_time = time.time()
    
    # Analyser le projet
    results = analyzer.analyze_project_parallel(project_dir, plugin_commands)
    
    end_time = time.time()
    duration = end_time - start_time
    
    print(f"‚è±Ô∏è  Temps d'analyse: {duration:.2f} secondes")
    print(f"üìä √âl√©ments analys√©s: {len(results)}")
    
    # Afficher quelques r√©sultats
    if results:
        print(f"\nüìã Exemples de r√©sultats:")
        for i, result in enumerate(results[:3], 1):
            print(f"   {i}. {result.get('element_id', 'Inconnu')} ({result.get('plugin', 'Inconnu')}) - {result.get('statut', 'Inconnu')}")
    
    print()

def demo_enhanced_report():
    """D√©monstration du rapport am√©lior√© avec toutes les fonctionnalit√©s."""
    print("üöÄ D√©monstration du rapport am√©lior√© complet")
    print("=" * 50)
    
    # Cr√©er le g√©n√©rateur avec cache et parall√©lisation
    generator = ReportGenerator(
        project_dir=str(pathlib.Path.cwd()),
        enable_cache=True,
        max_workers=4
    )
    
    # Analyser le projet en parall√®le
    plugin_commands = {
        "cm": "calc",
        "bois": "check",
        "beton": "calc",
        "hydrodrain": "calc"
    }
    
    print("üîÑ Analyse du projet en cours...")
    results = generator.analyze_project_parallel(plugin_commands)
    
    if results:
        # G√©n√©rer la synth√®se
        synthesis = ReportAnalyzer.generate_synthesis(results)
        
        print(f"üìä Synth√®se g√©n√©r√©e:")
        print(f"   ‚Ä¢ Total √©l√©ments: {synthesis['total_elements']}")
        print(f"   ‚Ä¢ Taux de succ√®s: {synthesis['success_rate']:.1f}%")
        print(f"   ‚Ä¢ Ratios critiques: {len(synthesis['critical_ratios'])}")
        
        # G√©n√©rer un rapport HTML avec synth√®se
        print("\nüìÑ G√©n√©ration du rapport HTML avec synth√®se...")
        output_path = generator.generate_html_report(results, "default.html", synthesis)
        
        if output_path:
            print(f"‚úÖ Rapport g√©n√©r√©: {output_path}")
        else:
            print("‚ùå √âchec de la g√©n√©ration du rapport")
    else:
        print("‚ùå Aucun r√©sultat √† analyser")
    
    print()

def show_usage_examples():
    """Affiche des exemples d'utilisation des nouvelles fonctionnalit√©s."""
    print("üìñ Exemples d'utilisation des fonctionnalit√©s avanc√©es:")
    print("=" * 60)
    
    examples = [
        ("Cache intelligent", "python -m src.lcpi.reporter --enable-cache"),
        ("Parall√©lisation", "python -m src.lcpi.reporter --max-workers 8"),
        ("Comparaison de rapports", "python -m src.lcpi.reporter --compare-with rapport_precedent.json"),
        ("Synth√®se intelligente", "python -m src.lcpi.reporter --format html --synthesis"),
        ("Toutes les fonctionnalit√©s", "python -m src.lcpi.reporter --enable-cache --max-workers 4 --compare-with ancien.json --format html")
    ]
    
    for desc, cmd in examples:
        print(f"  {desc}:")
        print(f"    {cmd}")
        print()

def main():
    """Fonction principale."""
    if len(sys.argv) > 1:
        if sys.argv[1] == "--help":
            print("""
Usage: python demo_advanced_features.py [option]

Options:
  --help          Affiche cette aide
  --cache         Test du syst√®me de cache
  --synthesis     Test de la synth√®se intelligente
  --comparison    Test de la comparaison de rapports
  --parallel      Test de l'analyse parall√®le
  --full          Test complet avec toutes les fonctionnalit√©s
            """)
            return
        elif sys.argv[1] == "--cache":
            demo_cache_system()
            return
        elif sys.argv[1] == "--synthesis":
            demo_synthesis()
            return
        elif sys.argv[1] == "--comparison":
            demo_comparison()
            return
        elif sys.argv[1] == "--parallel":
            demo_parallel_analysis()
            return
        elif sys.argv[1] == "--full":
            demo_enhanced_report()
            return
    
    # D√©monstration compl√®te par d√©faut
    print("üéØ D√âMONSTRATION DES FONCTIONNALIT√âS AVANC√âES LCPI-CLI")
    print("=" * 70)
    
    demo_cache_system()
    demo_synthesis()
    demo_comparison()
    demo_parallel_analysis()
    demo_enhanced_report()
    show_usage_examples()
    
    print("üéâ D√©monstration termin√©e !")

if __name__ == "__main__":
    main() 