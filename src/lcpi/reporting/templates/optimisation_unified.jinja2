<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Rapport Optimisation Réseau</title>
	{% if inline_css %}
	<style>
	{{ inline_css }}
	</style>
	{% endif %}
	<style>
:root{
	--bg:#0b0f13;
	--surface:#11161c;
	--surface-2:#161c23;
	--text:#e7edf4;
	--muted:#9db0c2;
	--brand:#4aa3ff;
	--ok:#21c55d;
	--ko:#ef4444;
	--border:#233041;
	--card-shadow:0 1px 0 rgba(0,0,0,.25),0 6px 20px rgba(0,0,0,.25);
	--radius:10px;
}

*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;line-height:1.45}
.report-container{max-width:1200px;margin:0 auto;padding:24px}

.page-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:24px}
h1{margin:0 0 6px 0;font-size:28px}
h2{margin:0 0 8px 0;font-weight:500;color:var(--muted)}
h3{margin:0 0 12px 0}
h4{margin:0 0 10px 0}
.muted{color:var(--muted)}
.meta-inline code{background:var(--surface-2);padding:2px 6px;border-radius:6px}

.toc{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin-bottom:20px}
.toc ul{margin:0;padding-left:18px}
.toc a{color:var(--brand);text-decoration:none}
.toc a:hover{text-decoration:underline}

.cards{display:grid;gap:16px}
.cards.two-col{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:900px){.cards.two-col{grid-template-columns:1fr}}

.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--card-shadow)}

.meta-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media (max-width:700px){.meta-grid{grid-template-columns:1fr}}

.kpi-row{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
@media (max-width:1100px){.kpi-row{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media (max-width:600px){.kpi-row{grid-template-columns:repeat(2,minmax(0,1fr))}}
.kpi{background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
.kpi-label{font-size:12px;color:var(--muted);margin-bottom:4px}
.kpi-value{font-size:18px;font-weight:600}
.kpi .unit{font-size:12px;margin-left:6px;color:var(--muted)}

.card-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
@media (max-width:1100px){.card-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:700px){.card-grid{grid-template-columns:1fr}}

.proposal-card{background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:12px}
.proposal-card .title{font-weight:600;margin-bottom:6px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#1a2430;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--text)}
.badge-ok{background:rgba(33,197,93,.12);border-color:rgba(33,197,93,.25);color:#a9efc8}
.badge-ko{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.25);color:#f9b3b3}
.proposal-card.ok{outline:1px solid rgba(33,197,93,.15)}
.proposal-card.ko{outline:1px solid rgba(239,68,68,.15)}
.mini-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
@media (max-width:700px){.mini-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}

.data-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--surface)}
.data-table thead th{position:sticky;top:0;background:#10161d;color:var(--muted);font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--border);z-index:1}
.data-table tbody td{padding:10px;border-bottom:1px solid #1f2a37}
.data-table tbody tr:nth-child(odd){background:#0f141b}
.data-table.compact tbody td{padding:6px 8px}
.data-table tbody tr:hover{background:#16202b}

.details{margin-top:10px}
.details > summary{cursor:pointer;list-style:none;background:var(--surface-2);border:1px solid var(--border);padding:8px 12px;border-radius:8px}
.details > summary::-webkit-details-marker{display:none}
.pre-json{max-height:420px;overflow:auto;background:#0e141a;border:1px solid var(--border);border-radius:8px;padding:12px}

.page-footer{margin-top:28px;color:var(--muted);text-align:center}
	</style>
</head>
<body>
	<div class="report-container">
		<header class="page-header">
			<div>
				<h1>Rapport d'Optimisation Réseau</h1>
				<h2>{{ projet_metadata.nom_projet if projet_metadata else "Projet LCPI" }}</h2>
				<div class="muted">
					{% if projet_metadata.client %}Client: {{ projet_metadata.client }} · {% endif %}
					Généré le {{ generation_date }} · LCPI v{{ version_lcpi }}
				</div>
			</div>
		</header>

		<main>
			<nav class="toc">
				<h3>Sommaire</h3>
				<ul>
					{% for log in logs_selectionnes %}
						<li><a href="#log-{{ loop.index }}">{{ loop.index }}. {{ log.titre_calcul }}</a></li>
					{% endfor %}
				</ul>
			</nav>

			{% macro kpi(label, value, unit='') -%}
			<div class="kpi">
				<div class="kpi-label">{{ label }}</div>
				<div class="kpi-value">
					{{ value if value is not none else '—' }}{% if unit %}<span class="unit">{{ unit }}</span>{% endif %}
				</div>
			</div>
			{%- endmacro %}

			{% for log in logs_selectionnes %}
				{% set data = log.donnees_resultat %}
				{% set meta = data.meta if data.meta is defined else {} %}
				{% set constraints = meta.constraints if meta.constraints is defined else {} %}
				{% set proposals = data.proposals if data.proposals is defined else [] %}
				{% set best = proposals[0] if proposals|length > 0 else {} %}
				{% set hyd = data.hydraulics if data.hydraulics is defined else {} %}
				{% set pressures = hyd.pressures_m if hyd.pressures_m is defined else (hyd.pressures if hyd.pressures is defined else {}) %}
				{% set velocities = hyd.velocities_m_s if hyd.velocities_m_s is defined else (hyd.velocities if hyd.velocities is defined else {}) %}
				{% set diameters = hyd.diameters_mm if hyd.diameters_mm is defined else (best.diameters_mm if best.diameters_mm is defined else {}) %}
				{% set min_pressure = (best.metrics.min_pressure_m if best.metrics is defined and best.metrics.min_pressure_m is defined else best.min_pressure_m) %}
				{% set max_velocity = (best.metrics.max_velocity_m_s if best.metrics is defined and best.metrics.max_velocity_m_s is defined else best.max_velocity_m_s) %}

				<section class="log-section" id="log-{{ loop.index }}">
					<div class="section-header">
						<h3>{{ loop.index }}. {{ log.titre_calcul }}</h3>
						<div class="meta-inline muted">
							ID: {{ log.id }} · {{ log.timestamp[:19].replace('T',' ') }} · Commande: <code>{{ log.commande_executee }}</code>
						</div>
					</div>

					<div class="cards two-col">
						<div class="card">
							<h4>Métadonnées</h4>
							<div class="meta-grid">
								<div><span class="muted">Fichier réseau</span><div>{{ (meta.source_meta.file if meta.source_meta is defined and meta.source_meta.file is defined else '') or (data.report_payload.metadata.network_file if data.report_payload is defined and data.report_payload.metadata is defined else '—') }}</div></div>
								<div><span class="muted">Méthode</span><div>{{ meta.method or (data.report_payload.metadata.method if data.report_payload is defined else '—') }}</div></div>
								<div><span class="muted">Solveur</span><div>{{ meta.solver or (data.report_payload.metadata.solver if data.report_payload is defined else '—') }}</div></div>
								<div><span class="muted">Contraintes</span>
									<div>
										Pmin: {{ constraints.pressure_min_m or '—' }} m ·
										Vmin: {{ constraints.velocity_min_m_s or '—' }} m/s ·
										Vmax: {{ constraints.velocity_max_m_s or '—' }} m/s
									</div>
								</div>
							</div>
						</div>

						<div class="card">
							<h4>Résumé</h4>
							<div class="kpi-row">
								{{ kpi('Contraintes OK', ('Oui' if best.constraints_ok else 'Non') if best.constraints_ok is not none else '—') }}
								{{ kpi('Min pression', ('%.3f'|format(min_pressure)) if min_pressure is not none else None, 'm') }}
								{{ kpi('Max vitesse', ('%.3f'|format(max_velocity)) if max_velocity is not none else None, 'm/s') }}
								{{ kpi('CAPEX', ('%.0f'|format(best.CAPEX)) if best.CAPEX is not none else None, 'FCFA') }}
								{{ kpi('Noeuds', (pressures|length) if pressures else 0) }}
								{{ kpi('Liaisons', (velocities|length) if velocities else 0) }}
							</div>
						</div>
					</div>

					{% if proposals and proposals|length > 0 %}
					<div class="card">
						<h4>Propositions</h4>
						<div class="card-grid">
							{% for p in proposals %}
							<div class="proposal-card {% if p.constraints_ok %}ok{% else %}ko{% endif %}">
								<div class="title">{{ p.id or p.name or ('proposition ' ~ loop.index) }}</div>
								<div class="badges">
									<span class="badge {% if p.constraints_ok %}badge-ok{% else %}badge-ko{% endif %}">{{ 'OK' if p.constraints_ok else 'KO' }}</span>
									{% if p.metrics is defined and p.metrics.performance_hydraulique is defined %}
										<span class="badge">Perf hydro: {{ '%.3f'|format(p.metrics.performance_hydraulique) }}</span>
									{% endif %}
								</div>
								<div class="mini-grid">
									<div><span class="muted">CAPEX</span><div>{{ '%.0f'|format(p.CAPEX) if p.CAPEX is not none else '—' }}</div></div>
									<div><span class="muted">Min P</span><div>{{ '%.3f'|format(p.min_pressure_m) if p.min_pressure_m is not none else '—' }} m</div></div>
									<div><span class="muted">Max V</span><div>{{ '%.3f'|format(p.max_velocity_m_s) if p.max_velocity_m_s is not none else '—' }} m/s</div></div>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
					{% endif %}

					<div class="cards two-col">
						<div class="card">
							<h4>Hydraulique — Pressions (Top plus faibles)</h4>
							{% if pressures %}
								{% set pres_sorted_asc = pressures | dictsort(by='value') %}
								<table class="data-table">
									<thead><tr><th>Noeud</th><th>Pression (m)</th></tr></thead>
									<tbody>
										{% for k,v in pres_sorted_asc[:20] %}
										<tr><td>{{ k }}</td><td>{{ '%.3f'|format(v) }}</td></tr>
										{% endfor %}
									</tbody>
								</table>
								<details class="details">
									<summary>Voir toutes les pressions</summary>
									<table class="data-table compact">
										<thead><tr><th>Noeud</th><th>Pression (m)</th></tr></thead>
										<tbody>
											{% for k,v in pres_sorted_asc %}
											<tr><td>{{ k }}</td><td>{{ '%.3f'|format(v) }}</td></tr>
											{% endfor %}
										</tbody>
									</table>
								</details>
							{% else %}
								<p class="muted">Aucune donnée de pression.</p>
							{% endif %}
						</div>

						<div class="card">
							<h4>Hydraulique — Vitesses (Top plus élevées)</h4>
							{% if velocities %}
								{% set vel_sorted_desc = velocities | dictsort(by='value', reverse=True) %}
								<table class="data-table">
									<thead><tr><th>Liaison</th><th>Vitesse (m/s)</th></tr></thead>
									<tbody>
										{% for k,v in vel_sorted_desc[:20] %}
										<tr><td>{{ k }}</td><td>{{ '%.3f'|format(v) }}</td></tr>
										{% endfor %}
									</tbody>
								</table>
								<details class="details">
									<summary>Voir toutes les vitesses</summary>
									<table class="data-table compact">
										<thead><tr><th>Liaison</th><th>Vitesse (m/s)</th></tr></thead>
										<tbody>
											{% for k,v in vel_sorted_desc %}
											<tr><td>{{ k }}</td><td>{{ '%.3f'|format(v) }}</td></tr>
											{% endfor %}
										</tbody>
									</table>
								</details>
							{% else %}
								<p class="muted">Aucune donnée de vitesse.</p>
							{% endif %}
						</div>
					</div>

					<div class="cards two-col">
						<div class="card">
							<h4>Hydraulique — Charges (Heads)</h4>
							{% set heads = hyd.heads_m if hyd.heads_m is defined else (hyd.heads if hyd.heads is defined else {}) %}
							{% if heads %}
								{% set heads_sorted_desc = heads | dictsort(by='value', reverse=True) %}
								<table class="data-table">
									<thead><tr><th>Noeud</th><th>Charge (m)</th></tr></thead>
									<tbody>
										{% for k,v in heads_sorted_desc[:20] %}
										<tr><td>{{ k }}</td><td>{{ '%.3f'|format(v) }}</td></tr>
										{% endfor %}
									</tbody>
								</table>
								<details class="details">
									<summary>Voir toutes les charges</summary>
									<table class="data-table compact">
										<thead><tr><th>Noeud</th><th>Charge (m)</th></tr></thead>
										<tbody>
											{% for k,v in heads_sorted_desc %}
											<tr><td>{{ k }}</td><td>{{ '%.3f'|format(v) }}</td></tr>
											{% endfor %}
										</tbody>
									</table>
								</details>
							{% else %}
								<p class="muted">Aucune donnée de charge.</p>
							{% endif %}
						</div>

						<div class="card">
							<h4>Hydraulique — Pertes de charge</h4>
							{% set hl = hyd.headlosses_m if hyd.headlosses_m is defined else (hyd.headlosses if hyd.headlosses is defined else {}) %}
							{% if hl %}
								{% set hl_sorted_desc = hl | dictsort(by='value', reverse=True) %}
								<table class="data-table">
									<thead><tr><th>Liaison</th><th>Pertes (m)</th></tr></thead>
									<tbody>
										{% for k,v in hl_sorted_desc[:20] %}
										<tr><td>{{ k }}</td><td>{{ '%.6f'|format(v) }}</td></tr>
										{% endfor %}
									</tbody>
								</table>
								<details class="details">
									<summary>Voir toutes les pertes</summary>
									<table class="data-table compact">
										<thead><tr><th>Liaison</th><th>Pertes (m)</th></tr></thead>
										<tbody>
											{% for k,v in hl_sorted_desc %}
											<tr><td>{{ k }}</td><td>{{ '%.6f'|format(v) }}</td></tr>
											{% endfor %}
										</tbody>
									</table>
								</details>
							{% else %}
								<p class="muted">Aucune donnée de perte de charge.</p>
							{% endif %}
						</div>
					</div>

					<div class="card">
						<h4>Hydraulique — Débits (m³/s)</h4>
						{% set flows = hyd.flows_m3_s if hyd.flows_m3_s is defined else {} %}
						{% if flows %}
							{% set flows_sorted_desc = flows | dictsort(by='value', reverse=True) %}
							<table class="data-table">
								<thead><tr><th>Liaison</th><th>Débit (m³/s)</th></tr></thead>
								<tbody>
									{% for k,v in flows_sorted_desc[:20] %}
									<tr><td>{{ k }}</td><td>{{ '%.6f'|format(v) }}</td></tr>
									{% endfor %}
								</tbody>
							</table>
							<details class="details">
								<summary>Voir tous les débits</summary>
								<table class="data-table compact">
									<thead><tr><th>Liaison</th><th>Débit (m³/s)</th></tr></thead>
									<tbody>
										{% for k,v in flows_sorted_desc %}
										<tr><td>{{ k }}</td><td>{{ '%.6f'|format(v) }}</td></tr>
										{% endfor %}
									</tbody>
								</table>
							</details>
						{% else %}
							<p class="muted">Aucune donnée de débit.</p>
						{% endif %}
					</div>

					<div class="card">
						<h4>Diamètres</h4>
						{% if diameters %}
							{% set dia_sorted_desc = diameters | dictsort(by='value', reverse=True) %}
							<table class="data-table">
								<thead><tr><th>Conduite</th><th>Diamètre (mm)</th></tr></thead>
								<tbody>
									{% for k,v in dia_sorted_desc %}
									<tr><td>{{ k }}</td><td>{{ v }}</td></tr>
									{% endfor %}
								</tbody>
							</table>
						{% else %}
							<p class="muted">Aucun diamètre disponible.</p>
						{% endif %}
					</div>

					<details class="details">
						<summary>Données brutes (JSON)</summary>
						<pre class="pre-json">{{ data | tojson(indent=2) }}</pre>
					</details>
				</section>
			{% endfor %}
		</main>

		<footer class="page-footer">
			Rapport généré le {{ generation_date }} — LCPI v{{ version_lcpi }}
		</footer>
	</div>
</body>
</html>


